---
## Front matter
title: "Отчёт по лабораторной работе 7"
subtitle: "Расширенные настройки межсетевого экрана"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получить навыки настройки межсетевого экрана в Linux в части переадресации портов и настройки Masquerading.

# Выполнение работы

## Создание пользовательской службы firewalld

1. Выполнен вход в рабочий каталог проекта и запущена виртуальная машина **server**. После загрузки системы выполнен переход в режим суперпользователя для выполнения административных операций.

2. На основе стандартного файла описания службы **ssh** создан пользовательский файл службы **ssh-custom.xml**. Файл был скопирован из системного каталога `/usr/lib/firewalld/services/` в каталог пользовательских служб `/etc/firewalld/services/`.

3. Просмотрено содержимое файла `ssh-custom.xml`. Файл представляет собой XML-описание службы firewalld и включает:
   - декларацию версии XML;
   - корневой элемент `<service>`;
   - элемент `<short>`, содержащий краткое имя службы;
   - элемент `<description>`, описывающий назначение службы;
   - элемент `<port>`, задающий протокол и номер порта, разрешённого для данной службы.

   ![Просмотр содержимого ssh-custom.xml](01.png){ #fig:002 width=80% }

4. Файл службы был открыт для редактирования. В нём изменён номер порта с **22** на **2022**, а описание службы скорректировано для указания, что используется модифицированная версия службы SSH.

   ![Редактирование файла ssh-custom.xml](02.png){ #fig:003 width=80% }

5. Получен список доступных служб firewalld. Установлено, что созданная пользовательская служба на данном этапе ещё не активна.

   ![Список доступных служб firewalld](03.png){ #fig:004 width=80% }

6. Выполнена перезагрузка правил межсетевого экрана с сохранением текущего состояния. После перезагрузки повторно выведен список служб, в котором появилась служба **ssh-custom**, однако она не была активирована.

   ![Перезагрузка firewalld и проверка служб](04.png){ #fig:005 width=80% }

7. Пользовательская служба **ssh-custom** добавлена в активные службы текущей зоны. После этого выполнено постоянное добавление службы с сохранением конфигурации и повторная перезагрузка firewalld.

## Перенаправление портов

1. На сервере настроено перенаправление входящих TCP-соединений с порта **2022** на стандартный порт службы SSH **22**.

   ![Настройка перенаправления портов](05.png){ #fig:007 width=80% }

2. На клиентской виртуальной машине выполнена попытка подключения к серверу по SSH через порт **2022**. Подключение прошло успешно, что подтверждает корректность настройки перенаправления портов.

   ![Подключение к серверу по SSH через порт 2022](06.png){ #fig:008 width=80% }

## Настройка Port Forwarding и Masquerading

1. Проверено состояние параметров ядра, отвечающих за пересылку IPv4-пакетов. Установлено, что перенаправление пакетов по умолчанию отключено.

2. Включена поддержка перенаправления IPv4-пакетов путём добавления соответствующей настройки в файл `/etc/sysctl.d/90-forward.conf` и применения параметров ядра.

3. Для внешнего сетевого интерфейса включён режим маскарадинга, обеспечивающий трансляцию сетевых адресов. После внесения изменений выполнена перезагрузка правил межсетевого экрана.

   ![Включение IP forwarding и masquerading](07.png){ #fig:009 width=80% }

4. На клиентской виртуальной машине проверена доступность выхода в сеть Интернет. Доступ подтверждён, что свидетельствует о корректной работе настроек Port Forwarding и Masquerading.

   ![Выход в сеть Интернет](08.png){ #fig:011 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. В каталоге `/vagrant/provision/server` создана структура каталогов для хранения конфигурационных файлов FirewallD и параметров ядра.

2. В соответствующие подкаталоги помещены конфигурационные файлы пользовательской службы `ssh-custom.xml` и файл настроек ядра `90-forward.conf`.

3. В каталоге `/vagrant/provision/server` создан исполняемый файл `firewall.sh`, предназначенный для автоматизации настройки межсетевого экрана, применения перенаправления портов и маскарадинга при развёртывании виртуальной машины.

   ![firewall.sh](09.png){ #fig:010 width=80% }

# Вывод

В ходе работы была создана и настроена пользовательская служба **firewalld** на основе стандартной службы SSH. Выполнена модификация конфигурации с изменением порта, произведена активация службы и проверка её работы. Реализовано перенаправление портов, включены механизмы **Port Forwarding** и **Masquerading**, что обеспечило корректную маршрутизацию и доступ клиентов к внешней сети. Дополнительно подготовлены файлы и скрипт автоматизации для применения настроек в среде Vagrant.

# Контрольные вопросы

1. **Где хранятся пользовательские файлы firewalld?**  
   Пользовательские файлы firewalld хранятся в каталоге `/etc/firewalld/`, в частности описания служб размещаются в `/etc/firewalld/services/`.

2. **Какую строку надо включить в пользовательский файл службы, чтобы указать порт TCP 2022?**  
   Для указания порта необходимо добавить строку  
   `<port protocol="tcp" port="2022"/>`.

3. **Какая команда позволяет перечислить все службы, доступные в настоящее время на вашем сервере?**  
   Для вывода списка всех доступных служб используется команда `firewall-cmd --get-services`.

4. **В чем разница между трансляцией сетевых адресов (NAT) и маскарадингом (masquerading)?**  
   NAT предполагает статическое сопоставление внутренних и внешних IP-адресов, тогда как маскарадинг является динамической формой NAT и автоматически подставляет внешний IP-адрес интерфейса, что удобно при использовании изменяемых адресов.

5. **Какая команда разрешает входящий трафик на порт 4404 и перенаправляет его в службу ssh по IP-адресу 10.0.0.10?**  
   Для этого используется команда перенаправления портов с указанием целевого адреса и порта службы SSH.

6. **Какая команда используется для включения маскарадинга IP-пакетов для всех пакетов, выходящих в зону public?**  
   Маскарадинг для зоны public включается с помощью команды `firewall-cmd --zone=public --add-masquerade --permanent`.


# Список литературы

1. NAT: вопросы и ответы. — URL: https://www.cisco.com/cisco/web/support/RU/9/92/92029_nat-faq.html (дата обр. 13.09.2021).
2. Динамический брандмауэр с использованием FirewallD. — URL: https://fedoraproject.org/wiki/FirewallD/ru (дата обр. 13.09.2021).
3. Одом У. Официальное руководство Cisco по подготовке к сертификационным экзаменам CCENT/CCNA ICND1 100-101. — М.: Вильямс, 2017. — 912 с. — (Cisco Press Core Series).
4. Часто задаваемые вопросы по технологии NAT / Сайт поддержки продуктов и технологий компании Cisco. — URL: https://www.cisco.com/c/ru_ru/support/docs/ip/network-address-translation-nat/26704-nat-faq-00.html (дата обр. 13.09.2021).