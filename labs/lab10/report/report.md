---
## Front matter
title: "Отчёт по лабораторной работе 10"
subtitle: "Расширенные настройки"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.

# Выполнение работы

## Настройка LMTP в Dovecot

1. На виртуальной машине **server** выполнен вход под пользователем и получены права суперпользователя.

2. Во втором терминале запущен мониторинг журнала почтовой службы.

3. В файле `/etc/dovecot/dovecot.conf` добавлен протокол LMTP. Теперь Dovecot работает с протоколами: IMAP, POP3 и LMTP.

   ![Добавление LMTP в список протоколов](01.png){ #fig:001 width=80% }

4. В файле `/etc/dovecot/conf.d/10-master.conf` настроен сервис LMTP для взаимодействия с Postfix через сокет. Определено расположение unix-сокета, а также доступ и принадлежность к пользователю и группе `postfix`.

   ![Настройка сервиса LMTP и unix-сокета](02.png){ #fig:002 width=80% }

5. В Postfix перенастроена доставка почты через LMTP-сокет, предоставляемый Dovecot.

6. В файле `/etc/dovecot/conf.d/10-auth.conf` установлен формат логина без доменной части. Теперь для авторизации используется только имя пользователя.

   ![Настройка auth_username_format](03.png){ #fig:003 width=80% }

7. Перезапущены службы Postfix и Dovecot для применения изменений.

8. Из клиентской машины отправлено тестовое письмо на локальный почтовый сервер и включено наблюдение за логами службы. По журналу видно, что Postfix принял сообщение и передал его в Dovecot через LMTP, после чего письмо было помещено в почтовый ящик пользователя. В логах отображены строки успешной передачи и статус `250 2.0.0`, подтверждающий доставку.

   ![Отправка тестового письма](04.png){ #fig:004 width=80% }
   ![Логи передачи сообщения через LMTP](05.png){ #fig:005 width=80% }

9. Почтовый ящик пользователя проверен. Сообщение с темой *"LMTP test"* успешно доставлено и отображается в списке писем.

   ![Полученное письмо в Maildir](06.png){ #fig:006 width=80% }

## Настройка SMTP-аутентификации

1. В файле `/etc/dovecot/conf.d/10-master.conf` определена служба аутентификации пользователей.  
   Каждая строка выполняет следующую функцию:

   - `service auth {` — объявляется сервис аутентификации Dovecot.
   - `unix_listener /var/spool/postfix/private/auth {` — создаётся unix-сокет, через который Postfix будет обращаться к Dovecot для проверки логинов.
   - `group = postfix` — права доступа к сокету предоставляются группе `postfix`.
   - `user = postfix` — владельцем сокета назначается пользователь `postfix`.
   - `mode = 0660` — разрешён доступ только владельцу и группе.
   - `unix_listener auth-userdb {` — создаётся второй сокет для взаимодействия с внутренней базой пользователей Dovecot.
   - `mode = 0600` — доступ к сокету есть только у владельца.
   - `user = dovecot` — владельцем сокета является сервис `dovecot`.
   - `}` — закрывает определение сервиса.

   ![Настройка unix-сокета для аутентификации](07.png){ #fig:007 width=80% }

2. В Postfix указан тип аутентификации и путь к используемому unix-сокету Dovecot.

   ![Команды postconf для настройки SASL](08.png){ #fig:008 width=80% }

3. Добавлены ограничения на обработку входящих писем:

   - `reject_unknown_recipient_domain` — отклоняет письма, если домен получателя не существует.
   - `permit_mynetworks` — разрешает приём почты только от доверённых хостов.
   - `reject_non_fqdn_recipient` — отклоняет письма на адреса без полного доменного имени.
   - `reject_unauth_destination` — блокирует пересылку писем на сторонние домены (защита от использования как open-relay).
   - `reject_unverified_recipient` — отклоняет сообщения, если невозможно проверить существование получателя.
   - `permit` — пропускает письмо после выполнения предыдущих условий.

4. Настроено ограничение `mynetworks`, что позволяет принимать почту только с локального SMTP-адреса сервера.

5. В файле `master.cf` временно включена SMTP-аутентификация на порту 25:

   ![Изменение master.cf](09.png){ #fig:009 width=80% }

6. Перезапущены службы Postfix и Dovecot.

7. На клиентской машине установлен telnet.

8. Сформирована строка для аутентификации в формате base64.

9. Выполнено подключение к SMTP-серверу. Проверена SMTP-аутентификация — сервер принимает авторизацию и возвращает статус успешного входа.

   ![Проверка SMTP AUTH через telnet](10.png){ #fig:010 width=80% }

## Настройка SMTP over TLS

1. На сервере настроен TLS, использован временный сертификат Dovecot.  
   Файлы сертификата и ключа скопированы в директории, используемые Postfix, что позволяет избежать конфликтов SELinux.

   ![Копирование сертификатов и конфигурирование TLS](11.png){ #fig:011 width=80% }

2. В Postfix указаны пути к сертификату, ключу и к каталогу кеша TLS-сессий.  
   Также определён уровень безопасности TLS для входящих и исходящих соединений.

3. Для запуска SMTP-сервера на порту **587** выполнена корректировка файла `master.cf`.  
   Добавлена секция для режима `submission` с обязательным использованием STARTTLS и требованием аутентификации.

   ![Настройка master.cf для submission и STARTTLS](12.png){ #fig:012 width=80% }

4. В межсетевом экране открыта служба `smtp-submission`, чтобы разрешить подключение на порт 587.

5. Postfix перезапущен для применения настроек.

6. На клиентской машине выполнено подключение к SMTP-серверу по порту 587 через `openssl` с использованием STARTTLS.  
   Сервер принимает сертификат (самоподписанный), происходит успешная SMTP-аутентификация.

   ![Проверка подключения через openssl](13.png){ #fig:013 width=80% }

7. В почтовом клиенте Evolution изменены настройки: сервер исходящей почты — порт **587**, тип шифрования **STARTTLS**, включена SMTP-аутентификация.

   ![Настройка SMTP в Evolution](14.png){ #fig:014 width=80% }

8. Отправление тестового письма через почтовый клиент прошло успешно.  
   Сообщение появляется в почтовом ящике пользователя на сервере.

   ![Полученное письмо в Evolution](15.png){ #fig:015 width=80% }

9. В логах Postfix фиксируется успешное прохождение TLS-соединения, SMTP-аутентификация и передача сообщения в Dovecot через LMTP.

   ![Логи успешной TLS-доставки](16.png){ #fig:016 width=80% }

## Внесение изменений во внутреннее окружение виртуальной машины

1. Конфигурационные файлы Postfix и Dovecot сохранены в каталог `/vagrant/provision/server/` для последующего автоматического развёртывания.

   ![Копирование конфигурационных файлов](17.png){ #fig:017 width=80% }

2. В файл `mail.sh`, используемый для развёртывания окружения, внесены изменения, включающие автоматическую установку пакетов и конфигурирование Postfix/Dovecot.

   ![Обновление provisioning-скрипта mail.sh](18.png){ #fig:018 width=80% }

# Вывод

В ходе выполнения работы был настроен почтовый сервер с поддержкой SMTP-аутентификации и передачей почты по защищённому каналу TLS. Настроено взаимодействие Postfix и Dovecot через LMTP, реализована аутентификация пользователей, включена поддержка STARTTLS на 587-м порту. Проверена отправка и получение писем как через консольные утилиты, так и через почтовый клиент. Конфигурационные файлы сохранены в инфраструктуру Vagrant, что позволяет автоматизировать развертывание и повторное использование настроек.

# Контрольные вопросы

1. **Приведите пример задания формата аутентификации пользователя в Dovecot в форме логина с указанием домена.**  
   Для задания формата имени пользователя с обязательным указанием домена используется параметр:
   `auth_username_format = %n@%d`
   В таком случае пользователь должен вводить логин полностью, например: `user@example.com`.

2. **Какие функции выполняет почтовый Relay-сервер?**  
Relay-сервер принимает электронную почту и передает её на другой SMTP-сервер.  
Он используется как промежуточное звено между отправителем и конечным получателем, например, между внутренними почтовыми системами и внешними сервисами доставки.

3. **Какие угрозы безопасности могут возникнуть в случае настройки почтового сервера как Relay-сервера?**  
Если сервер открыт для пересылки писем посторонним пользователям (Open Relay), он может быть использован злоумышленниками для рассылки спама. Это приводит к:
- внесению IP-адреса в спам-черные списки;
- блокировке почты другими почтовыми сервисами;
- повышенной нагрузке на ресурсы сервера;
- репутационным рискам и возможному отключению интернет-провайдером.
 


# Список литературы

1. Postfix SASL Howto. — URL: http://www.postfix.org/SASL_README.html (visited on 09/13/2021).