---
## Front matter
title: "Отчёт по лабораторной работе 14"
subtitle: "Настройка файловых служб Samba"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Выполнение работы

## Настройка сервера Samba

### Установка необходимых пакетов

1. На сервер были установлены пакеты **samba**, **samba-client**, **cifs-utils**.

2. Создана группа **sambagroup** с GID 1010, после чего пользователь был добавлен в эту группу.

3. Создан каталог для общего ресурса.

   ![Создание каталога /srv/sambashare](01.png){ #fig:001 width=80% }

### Настройка конфигурации Samba

1. В файл `/etc/samba/smb.conf` внесены изменения:
   - Изменена рабочая группа на `ZMUSTAFAEV-NET`.
   - Добавлен раздел общего ресурса `[sambashare]`.

   ![Редактирование smb.conf](02.png){ #fig:002 width=80% }

2. Проверен файл конфигурации с помощью `testparm` — ошибок синтаксиса не обнаружено.

### Запуск службы Samba

1. Служба **smb** была запущена и добавлена в автозагрузку.
2. Статус подтверждает корректную работу демона.

3. Проверено наличие общих ресурсов через подключение `smbclient -L //server`.

   ![Проверка общего доступа через smbclient](03.png){ #fig:003 width=80% }

### Настройка межсетевого экрана

1. Изучено описание службы Samba в системе **firewalld**.

   ![Просмотр файла samba.xml](04.png){ #fig:004 width=80% }

2. В firewall добавлена служба Samba, изменения применены.

### Настройка прав доступа и SELinux

1. Назначена группа владельца каталога `/srv/sambashare` и настроены права.

2. Просмотрены текущие SELinux-контексты:

3. Настроены корректные контексты SELinux для каталога:

   ![Настройка SELinux-контекстов](05.png){ #fig:005 width=80% }

4. Проверено, что контексты были изменены:

5. Разрешён экспорт Samba-ресурсов для чтения и записи.

### Создание файла пользователем sambagroup

1. Проверены UID и группы пользователя.

2. Выполнено создание тестового файла пользователем в каталоге sambashare.

   ![Создание файла пользователем в sambashare](06.png){ #fig:006 width=80% }

### Добавление пользователя в базу Samba

1. Пользователь был добавлен в локальную базу SMB-пользователей.

   ![Добавление SMB-пользователя](07.png){ #fig:007 width=80% }

## Монтирование файловой системы Samba на клиенте

### Установка пакетов и настройка межсетевого экрана

1. На клиенте были установлены необходимые пакеты **samba-client** и **cifs-utils**.

2. Изучён файл конфигурации `samba-client.xml`, содержащий параметры сетевой службы:

   ![Просмотр samba-client.xml](08.png){ #fig:008 width=80% }

3. Настроен межсетевой экран: добавлена служба samba-client и применены изменения.

4. Создана группа **sambagroup** и пользователь добавлен в неё.

   ![Создание группы и добавление пользователя](09.png){ #fig:009 width=80% }

### Настройка Samba-клиента

1. В файл `/etc/samba/smb.conf` внесено изменение рабочей группы:

   ![Изменение рабочей группы в smb.conf](10.png){ #fig:010 width=80% }

2. Проверено подключение к серверу с помощью `smbclient -L //server` под анонимной учётной записью.

   **Просмотр выполняется под учётной записью Anonymous.**

3. Подключение выполнено под учётной записью пользователя:

   ![Просмотр ресурсов сервера под пользователем zmustafaev](11.png){ #fig:011 width=80% }

   **Просмотр выполняется под учётной записью ZMUSTAFAEV-NET\\zmustafaev.**

### Монтирование общего ресурса вручную

1. Создан каталог точки монтирования `/mnt/samba`.

2. Общий ресурс смонтирован по протоколу CIFS с указанием имени пользователя и группы.

   ![Монтирование ресурса Samba](12.png){ #fig:012 width=80% }

3. Выполнена проверка записи файлов пользователем клиента:

   ![Создание файла пользователем на смонтированном ресурсе](13.png){ #fig:013 width=80% }

### Автоматическое монтирование с использованием файла учётных данных

1. Создан файл `/etc/samba/smbusers` с учетными данными, доступ к нему ограничен:

   ![Файл с учётными данными smbusers](14.png){ #fig:014 width=80% }

2. В файл `/etc/fstab` добавлена строка автоматического монтирования Samba-ресурса:

   ![Добавление записи в fstab](15.png){ #fig:015 width=80% }

3. Проверено автоматическое монтирование командой `mount -a`:

   ![Проверка автоматического монтирования ресурсов](16.png){ #fig:016 width=80% }

4. Убедились, что файлы, созданные с клиента, видны на сервере:

   ![Проверка файлов на сервере](17.png){ #fig:017 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** выполнён переход в каталог `/vagrant/provision/server/`.  
   В нём создана структура каталогов для хранения конфигурации Samba, после чего был скопирован файл `smb.conf`:

2. В каталоге `/vagrant/provision/server` создан исполняемый файл `smb.sh`, в который был внесён скрипт, включающий:

   ![Скрипт smb.sh для сервера](18.png){ #fig:018 width=80% }

3. На виртуальной машине **client** выполнён переход в каталог `/vagrant/provision/client`, где создана директория для хранения настроек Samba.  
   Затем в неё были скопированы файлы `smb.conf` и `smbusers`.

4. В каталоге `/vagrant/provision/client` создан исполняемый файл `smb.sh`, содержащий:

   - установку пакетов samba-client и cifs-utils;  
   - копирование конфигурационных файлов;  
   - настройку firewalld;  
   - создание группы sambagroup и добавление пользователя;  
   - создание точки монтирования;  
   - автоматическое монтирование общего ресурса Samba.

   ![Скрипт smb.sh для клиента](19.png){ #fig:019 width=80% }

# Вывод

В ходе выполнения работы была реализована полноценная настройка серверной и клиентской части Samba. На сервере создан общий ресурс, настроены права доступа, SELinux-контексты и служба SMB. На клиенте обеспечено подключение к общему каталогу как вручную, так и через автоматическое монтирование с использованием файла учётных данных. Оба окружения дополнены скриптами автоматизации для Vagrant, что позволяет быстро разворачивать конфигурацию без ручных ошибок. Работа продемонстрировала принципы управления доступом, сетевыми службами и безопасностью при использовании Samba в Linux-инфраструктуре.

# Контрольные вопросы

1. **Какова минимальная конфигурация для smb.conf для создания общего ресурса, который предоставляет доступ к каталогу /data?**  
   Достаточно определить глобальный блок и описание ресурса:  

```
[global]
workgroup = WORKGROUP

[data]
path = /data
read only = no
browseable = yes
```

2. **Как настроить общий ресурс, который даёт доступ на запись всем пользователям, имеющим права на запись в файловой системе Linux?**  
Необходимо убрать ограничения Samba и опираться на права файловой системы:  

```
[data]
path = /data
read only = no
writeable = yes
force user = nobody
force group = users
```
При этом пользователи должны иметь доступ `rw` в самом каталоге Linux.

3. **Как ограничить доступ на запись к ресурсу только членам определённой группы?**  
Используется параметр `write list`:  

```
[data]
path = /data
read only = yes
write list = @sambagroup
```

4. **Какой переключатель SELinux нужно использовать, чтобы позволить пользователям получать доступ к домашним каталогам на сервере через SMB?**  
Переключатель:  

```
setsebool -P samba_enable_home_dirs on
```

5. **Как ограничить доступ к определённому ресурсу только узлам из сети 192.168.10.0/24?**  
Используются параметры `hosts allow` и `hosts deny`:  

```
[data]
path = /data
hosts allow = 192.168.10.0/24
hosts deny = 0.0.0.0/0
```

6. **Какую команду можно использовать, чтобы отобразить список всех пользователей Samba на сервере?**  
Команда:  

```
pdbedit -L
```

7. **Что нужно сделать пользователю для доступа к ресурсу, который настроен как многопользовательский ресурс?**  
Пользователь должен:  
- иметь локальную учётную запись в системе,  
- быть добавлен в нужную группу (если требуется),  
- иметь созданную SMB-учётную запись через `smbpasswd -a user`.

8. **Как установить общий ресурс Samba в качестве многопользовательской учётной записи, где пользователь alice используется как минимальная учётная запись пользователя?**  
Указывается параметр:  

```
username map = /etc/samba/smbusers
```

А в `/etc/samba/smbusers`:  

```
alice = user1 user2 user3
````

Все перечисленные пользователи будут отображены как alice.

9. **Как можно запретить пользователям просматривать учётные данные монтирования Samba в файле /etc/fstab?**  
Вынести пароль в файл с закрытыми правами доступа:  
- создать `/etc/samba/credentials` с правами `600`,  
- указать в fstab:  

  ```
  credentials=/etc/samba/credentials
  ```

10. **Какая команда позволяет перечислить все экспортируемые ресурсы Samba, доступные на определённом сервере?**  
 Команда:  
 
 ```
 smbclient -L //server
 ```

# Список литературы

1. Всё о Samba. — URL: http://smb-conf.ru/ (дата обр. 13.09.2021)