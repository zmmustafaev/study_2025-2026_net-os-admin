---
## Front matter
title: "Отчёт по лабораторной работе 3"
subtitle: "Настройка DHCP-сервера"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получить практические навыки установки и настройки DNS-сервера, а также закрепить понимание принципов работы системы доменных имён.

# Выполнение работы

# Выполнение работы

## Установка DHCP-сервера

1. На виртуальной машине **server** был установлен пакет **kea**, предоставляющий реализацию DHCP-сервера.

## Конфигурирование DHCP-сервера

1. В конфигурационном файле **/etc/kea/kea-dhcp4.conf** были заданы параметры:
   - в качестве сервера доменных имен указан адрес **192.168.1.1**;  
   - параметры `domain-search` и `code 15` изменены на домен **zmustafaev.net**.

   ![Редактирование domain-name и domain-search](Screenshot_1.png){ #fig:001 width=80% }

2. Определена подсеть **192.168.1.0/24** с диапазоном адресов от **192.168.1.30** до **192.168.1.199**, а также задан маршрут по умолчанию через **192.168.1.1**.

   ![Конфигурация подсети DHCP](Screenshot_2.png){ #fig:002 width=80% }

3. В файл прямой зоны **/var/named/master/fz/zmustafaev.net** добавлена запись, указывающая на DHCP-сервер с адресом **192.168.1.1**.

   ![Редактирование прямой зоны DNS](Screenshot_3.png){ #fig:003 width=80% }

4. В файл обратной зоны **/var/named/master/rz/192.168.1** добавлена запись, соответствующая имени **dhcp.zmustafaev.net**.

   ![Редактирование обратной зоны DNS](Screenshot_4.png){ #fig:004 width=80% }

5. После внесённых изменений служба **named** была перезапущена. Доступность DHCP-сервера подтверждена проверкой через обращение по имени.

   ![Проверка доступности DHCP-сервера](Screenshot_5.png){ #fig:005 width=80% }

6. Для обеспечения работы сервиса были добавлены правила в **firewalld**, а также восстановлены контексты безопасности SELinux.

   ![Настройка firewalld и SELinux](Screenshot_6.png){ #fig:006 width=80% }

7. DHCP-сервис **kea-dhcp4** успешно запущен.

## Анализ работы DHCP-сервера

1. Для корректной маршрутизации на виртуальной машине **client** был создан скрипт, который перенаправляет весь трафик через интерфейс **eth1**. После его подключения и запуска виртуальная машина получила адрес от DHCP-сервера.

2. На клиенте подтверждено получение IP-адреса из заданного диапазона. Интерфейс **eth1** получил адрес **192.168.1.30** с маской сети **255.255.255.0** и шлюзом по умолчанию **192.168.1.1**. Интерфейс **lo** отобразил стандартные параметры локального соединения.

   ![Сетевые интерфейсы на клиенте](Screenshot_7.png){ #fig:007 width=80% }

   **Пояснение к выводу:**
   - строка с параметрами `eth1` показывает, что клиент подключён к сети и получил корректный IP-адрес;  
   - указан адрес Ethernet-адаптера (MAC-адрес), по которому DHCP-сервер идентифицирует клиента;  
   - интерфейс `lo` подтверждает стандартные параметры петлевого соединения.  

3. На сервере проверено состояние базы аренды DHCP. В файле **kea-leases4.csv** зафиксированы сведения о выданных адресах.  

   ![Файл с арендой DHCP-адресов](Screenshot_8.png){ #fig:008 width=80% }

   **Пояснение к записям:**
   - выданный адрес: **192.168.1.30**;  
   - MAC-адрес клиента: **08:00:27:3b:a1:76**;  
   - идентификатор клиента совпадает с MAC-адресом;  
   - время аренды: **3600 секунд (1 час)**;  
   - время истечения указывает момент окончания действия аренды;  
   - поле `subnet_id` показывает, что адрес был выдан из подсети **1 (192.168.1.0/24)**;  
   - флаг `fqdn_fwd` и `fqdn_rev` равен нулю, что означает отсутствие автоматической регистрации имени клиента в DNS;  
   - статус аренды активен (значение `1` в соответствующем поле).  

## Настройка обновления DNS-зоны

1. Для организации автоматического обновления записей зоны был создан ключ **DHCP_UPDATER** с использованием алгоритма HMAC-SHA512. Ключ подключён в конфигурацию Bind и права доступа настроены корректно.  

2. В конфигурации Bind были внесены изменения для разрешения динамического обновления записей прямой и обратной зон. Для этого использована политика update-policy с привязкой к созданному ключу.  

   ![Настройка зон с поддержкой обновления](Screenshot_9.png){ #fig:009 width=80% }

3. На стороне Kea был создан файл ключа в формате JSON. В нём описаны имя ключа, используемый алгоритм и секрет.  

   ![Файл tsig-keys.json](Screenshot_10.png){ #fig:010 width=80% }

4. Ключ был подключён в конфигурацию **kea-dhcp-ddns.conf**. Здесь заданы forward и reverse зоны, для которых разрешено обновление через DNS-сервер 192.168.1.1.  

   ![Настройка kea-dhcp-ddns.conf](Screenshot_11.png){ #fig:011 width=80% }

5. После проверки конфигурации служба **kea-dhcp-ddns** была запущена и успешно перешла в состояние *active (running)*.  

   ![Запуск службы kea-dhcp-ddns](Screenshot_12.png){ #fig:012 width=80% }

6. Для интеграции DHCP и DDNS в основной конфигурационный файл **kea-dhcp4.conf** были добавлены параметры, разрешающие обновления записей зоны. Указан домен zmustafaev.net, а также включено автоматическое переопределение обновлений от клиента.  

   ![Изменения в конфигурации kea-dhcp4.conf](Screenshot_13.png){ #fig:013 width=80% }

7. DHCP-сервер был перезапущен, что подтверждается статусом *active (running)*.  

   ![Запуск DHCP-сервера после изменений](Screenshot_14.png){ #fig:014 width=80% }

## Анализ работы DHCP-сервера после настройки обновления DNS-зоны

1. На клиентской машине была выполнена проверка с помощью утилиты **dig**. Запрос направлен к DNS-серверу с адресом **192.168.1.1** для имени **client.zmustafaev.net**.  

   ![Проверка DNS-записи клиента](Screenshot_15.png){ #fig:015 width=80% }

2. Разбор результата:  
   - в первой строке указан запуск утилиты **dig** с параметрами: запрос сделан к серверу 192.168.1.1 для имени `client.zmustafaev.net`;  
   - секция **HEADER** сообщает, что ответ получен успешно (*status: NOERROR*), ошибок при обработке не возникло;  
   - поле **QUESTION SECTION** повторяет запрошенное имя и тип записи (A-запись);  
   - в секции **ANSWER SECTION** показан результат: имя `client.zmustafaev.net` соответствует IP-адресу **192.168.1.30**;  
   - строка **SERVER** подтверждает, что ответ получен от локального сервера по адресу 192.168.1.1;  
   - поле **WHEN** фиксирует дату и время проведения запроса;  
   - значение **MSG SIZE rcvd** отражает размер полученного ответа.  

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На виртуальной машине **server** был создан каталог для хранения конфигурационных файлов DHCP. В него были скопированы все файлы из системного каталога `/etc/kea`, что позволяет сохранять актуальное состояние настроек.  

2. В каталоге **dns** были заменены конфигурационные файлы DNS-сервера. Для этого туда перенесены содержимое каталога `/var/named` и конфигурация из `/etc/named`. Благодаря этому настройки DNS также сохраняются внутри окружения Vagrant.  

3. В каталоге **/vagrant/provision/server** был создан исполняемый файл **dhcp.sh**. В нём последовательно реализованы:  
   - установка необходимых пакетов;  
   - копирование конфигурации DHCP из подготовленного каталога в системный;  
   - исправление прав доступа и восстановление контекстов безопасности;  
   - настройка межсетевого экрана для разрешения работы DHCP;  
   - перезапуск конфигурации systemd и активация служб **kea-dhcp4** и **kea-dhcp-ddns**.  

   Этот скрипт полностью автоматизирует процесс установки и настройки DHCP-сервера, повторяя вручную выполненные действия.  

4. Для автоматического выполнения скрипта при запуске виртуальной машины в конфигурационный файл **Vagrantfile** была добавлена секция, которая подключает и запускает **dhcp.sh** в процессе инициализации.  

5. После выполнения всех шагов виртуальные машины **client** и **server** были корректно остановлены.  


# Вывод

В ходе выполнения работы была развернута инфраструктура с использованием виртуальных машин **server** и **client**.  
На сервере были установлены и настроены службы **DNS** и **DHCP**, обеспечивающие автоматическую выдачу IP-адресов и разрешение имён в локальной сети.  


# Контрольные вопросы

1. **В каких файлах хранятся настройки сетевых подключений?**  
   В Linux настройки сетевых подключений обычно хранятся в каталоге **/etc/sysconfig/network-scripts/** (в системах на базе RHEL/CentOS) или в каталоге **/etc/NetworkManager/system-connections/** (при использовании NetworkManager). Там содержатся файлы с параметрами интерфейсов, адресацией, шлюзами и DNS.  

2. **За что отвечает протокол DHCP?**  
   Протокол **DHCP (Dynamic Host Configuration Protocol)** автоматически назначает клиентам сетевые параметры — IP-адрес, маску подсети, шлюз по умолчанию и адреса DNS-серверов. Это избавляет администратора от необходимости вручную настраивать каждое устройство в сети.  

3. **Поясните принцип работы протокола DHCP. Какими сообщениями обмениваются клиент и сервер, используя протокол DHCP?**  
   DHCP работает по схеме **DORA**:  
   - **Discover** — клиент отправляет широковещательный запрос для поиска DHCP-сервера;  
   - **Offer** — сервер предлагает свободный IP-адрес и параметры сети;  
   - **Request** — клиент выбирает одно из предложений и запрашивает подтверждение аренды;  
   - **Acknowledge** — сервер подтверждает выдачу адреса и завершает процесс настройки.  

4. **В каких файлах обычно находятся настройки DHCP-сервера? За что отвечает каждый из файлов?**  
   В случае **Kea DHCP** основные настройки содержатся в:  
   - **/etc/kea/kea-dhcp4.conf** — конфигурация DHCPv4, где задаются подсети, диапазоны IP-адресов и параметры опций;  
   - **/etc/kea/kea-dhcp-ddns.conf** — параметры взаимодействия DHCP с DNS (DDNS);  
   - **/etc/kea/tsig-keys.json** — ключи для аутентификации при динамическом обновлении DNS-зон.  
   Для **ISC DHCP** настройки обычно хранятся в файле **/etc/dhcp/dhcpd.conf**.  

5. **Что такое DDNS? Для чего применяется DDNS?**  
   **DDNS (Dynamic DNS)** — это технология автоматического обновления записей DNS. Она применяется для того, чтобы новые клиенты, получившие адрес от DHCP-сервера, автоматически регистрировались в DNS-зоне с актуальными IP-адресами. Это облегчает администрирование и позволяет всегда обращаться к устройствам по имени, а не по IP.  

6. **Какую информацию можно получить, используя утилиту ifconfig? Приведите примеры с использованием различных опций.**  
   Утилита **ifconfig** отображает параметры сетевых интерфейсов: IP-адрес, маску подсети, MAC-адрес, количество принятых и переданных пакетов.  
   - без параметров: информация обо всех активных интерфейсах;  
   - `ifconfig eth0` — сведения о конкретном интерфейсе;  
   - `ifconfig eth0 down` — отключение интерфейса;  
   - `ifconfig eth0 up` — включение интерфейса.  

7. **Какую информацию можно получить, используя утилиту ping? Приведите примеры с использованием различных опций.**  
   Утилита **ping** проверяет доступность узла и измеряет время отклика.  
   - `ping 192.168.1.1` — проверка доступности сервера по IP-адресу;  
   - `ping ya.ru` — проверка доступности ресурса по доменному имени;  
   - `ping -c 5 192.168.1.1` — отправка ограниченного числа пакетов (5 штук);  
   - `ping -i 2 192.168.1.1` — установка интервала между пакетами (2 секунды).  


# Список литературы

1. Barr D. Common DNS Operational and Configuration Errors: RFC 1912. — DOI: 10.17487/rfc1912.  
2. Droms R. Dynamic Host Configuration Protocol: RFC / RFC Editor. — 03/1997. — P. 1–45. — DOI: 10.17487/rfc2131.
3. Dynamic Updates in the Domain Name System (DNS UPDATE), RFC 2136: RFC / P. Vixie, S. Thomson, Y. Rekhter, J. Bound; RFC Editor. — 04/1997. — DOI: 10.17487/RFC2136.