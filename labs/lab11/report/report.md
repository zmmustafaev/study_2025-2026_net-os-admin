---
## Front matter
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по настройке удалённого доступа к серверу с помощью SSH.

# Выполнение работы

## Запрет удалённого доступа по SSH для пользователя root

1. На сервере был установлен пароль для пользователя root.
2. Запущен мониторинг системных событий с помощью journalctl.
3. С клиента выполнена попытка подключения по SSH под пользователем root.

   ![Попытка подключиться по SSH под root](01.png){ #fig:001 width=80% }

    сервер запрашивает пароль, но вход не выполняется — попытки аутентификации завершаются ошибкой.

4. На сервере в файле конфигурации `/etc/ssh/sshd_config` изменён параметр `PermitRootLogin` на значение `no`.

   ![Редактирование параметра PermitRootLogin no](02.png){ #fig:002 width=80% }

5. Произведён перезапуск службы SSH.
6. Повторная попытка подключения к серверу под пользователем root.

   ![Повторная попытка входа под root после изменения](03.png){ #fig:003 width=80% }

    удалённый вход под root стал невозможен — сервер блокирует попытку подключения, выводя ошибку `Permission denied`.  
   Это подтверждает, что вход root по SSH запрещён.

## Ограничение списка пользователей для удалённого доступа по SSH

1. С клиента выполнена попытка подключения по SSH под обычным пользователем.

   ![Успешная авторизация пользователем zmustafaev](04.png){ #fig:004 width=80% }

    вход выполнен успешно, пользователь получает доступ к серверу.

2. В файле `/etc/ssh/sshd_config` добавлена строка `AllowUsers vagrant`.

   ![Добавление AllowUsers vagrant](05.png){ #fig:005 width=80% }

3. Служба SSH была перезапущена.
4. Выполнена повторная попытка подключения под пользователем zmustafaev.

   ![Отказ при подключении после AllowUsers vagrant](06.png){ #fig:006 width=80% }

    доступ отклонён, так как в конфигурации разрешён только пользователь `vagrant`.

5. В файл `/etc/ssh/sshd_config` добавлены два пользователя:

   AllowUsers vagrant zmustafaev

   ![Добавление второго пользователя в AllowUsers](07.png){ #fig:007 width=80% }

6. После перезапуска службы SSH выполнена попытка входа под пользователем zmustafaev.

   ![Успешный вход после добавления пользователя](08.png){ #fig:008 width=80% }

    теперь пользователь входит успешно, так как он добавлен в список разрешённых пользователей.

## Настройка дополнительных портов для удалённого доступа по SSH

1. На сервере в файле конфигурации `/etc/ssh/sshd_config` добавлены строки:
   - Port 22  
   - Port 2022  
   Это позволяет службе SSH работать на двух портах одновременно, обеспечивая возможность подключения даже при ошибке в конфигурации одного из них.

   ![Добавление порта 2022 в sshd_config](09.png){ #fig:009 width=80% }

2. После сохранения изменений служба SSH была перезапущена, затем проверен её статус.

   ![Перезапуск и проверка статуса службы SSH](10.png){ #fig:010 width=80% }

    служба SSH запущена, но система сообщает об ошибке `Bind to port 2022 failed: Permission denied`.  
   Это означает, что SELinux не разрешает процессу sshd прослушивать новый порт 2022.

3. Для устранения ошибки были назначены корректные метки SELinux для порта 2022 с типом `ssh_port_t`.

4. После этого межсетевой экран был настроен на разрешение входящих соединений через порт 2022 протокола TCP.

5. Служба SSH была перезапущена повторно, и её состояние проверено повторно.

   ![Проверка статуса после исправления SELinux и firewall](11.png){ #fig:011 width=80% }

    теперь процесс SSH успешно слушает оба порта — 22 и 2022, что подтверждается сообщениями журнала.

6. С клиента выполнено подключение к серверу по SSH без указания порта.

   ![Подключение к серверу по стандартному порту 22](12.png){ #fig:012 width=80% }

    соединение установлено успешно, доступ к серверу получен, пользователь смог получить права root через sudo.

7. После выхода из системы выполнена повторная попытка подключения, но с указанием нового порта 2022.  
   Подключение прошло успешно, подтверждая корректную настройку дополнительного порта SSH.

## Настройка удалённого доступа по SSH по ключу

1. На сервере в файле `/etc/ssh/sshd_config` включена аутентификация по ключу с помощью параметра `PubkeyAuthentication yes`.

2. Служба SSH была перезапущена, чтобы изменения вступили в силу.

3. На клиенте под пользователем был сгенерирован SSH-ключ (`ssh-keygen`).  
   Созданы два файла: закрытый ключ `id_rsa` и открытый ключ `id_rsa.pub`.

4. Открытый ключ был скопирован на сервер с клиента.

5. Выполнено SSH-подключение к серверу без ввода пароля.

   ![Успешное подключение по ключу](14.png){ #fig:014 width=80% }

 вход на сервер по SSH теперь выполняется без запроса пароля, что подтверждает успешную настройку SSH-аутентификации по ключу.

## Организация SSH-туннеля (перенаправление TCP-портов)

1. На клиенте был запущен просмотр активных TCP-подключений.

2. Выполнено создание SSH-туннеля: локальный порт 8080 был связан с портом 80 на сервере.

   ![Создание SSH-туннеля](15.png){ #fig:015 width=80% }

3. Повторный вывод списка TCP-соединений показал, что теперь локальный порт 8080 находится в состоянии LISTEN.

   ![Проверка работы туннеля](16.png){ #fig:016 width=80% }

    в выводе видно, что процесс `ssh` слушает локальный порт 8080, перенаправляя весь трафик на порт 80 сервера.

4. В браузере на клиенте в адресной строке введён `localhost:8080`.  

   ![Страница, доступная через SSH-туннель](17.png){ #fig:017 width=80% }

 веб-страница загружается через SSH-туннель, что подтверждает корректную работу перенаправления портов.

## Запуск консольных приложений на сервере через SSH

1. С клиента было выполнено удалённое выполнение команды для определения имени хоста сервера.
2. Дальше выполнена команда для вывода списка файлов на сервере.
3. После этого был просмотр почтового ящика пользователя на сервере.

   ![Пример выполнения удалённых команд через SSH](18.png){ #fig:018 width=80% }

команды выполняются на сервере без открытия полноценной интерактивной оболочки. Это позволяет управлять сервером и запускать консольные приложения напрямую из клиентского терминала.

## Запуск графических приложений через SSH (X11Forwarding)

1. На сервере в конфигурационном файле `/etc/ssh/sshd_config` была разрешена возможность удалённого вывода графического интерфейса X11 с помощью параметра `X11Forwarding yes`.

   ![Включение X11Forwarding в sshd_config](19.png){ #fig:019 width=80% }

2. Служба SSH была перезапущена для применения изменений.

3. На клиенте выполнена попытка удалённого запуска графического приложения (firefox) с использованием опции X11-перенаправления.

   ![Попытка запуска графического приложения через SSH](20.png){ #fig:020 width=80% }

    X11-перенаправление не выполнено. В сообщении указано, что переменная окружения DISPLAY не определена. Это означает, что на клиентской стороне не настроена X11-среда (например, отсутствует X-server).

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На сервере был выполнен переход в каталог `/vagrant/provision/server/` и создана структура каталогов для хранения конфигурационных файлов SSH.  
   Затем файл `sshd_config` был скопирован в новую структуру каталогов.

   ![Создание каталога для конфигурации SSH](21.png){ #fig:021 width=80% }

2. В каталоге `/vagrant/provision/server/` был создан исполняемый файл `ssh.sh`, в который внесён скрипт для:
   - копирования конфигурационных файлов SSH в `/etc`,
   - настройки SELinux для работы порта 2022,
   - открытия порта 2022 в firewall,
   - перезапуска службы sshd.

   ![Содержимое скрипта ssh.sh](22.png){ #fig:022 width=80% }

 теперь при автоматическом запуске виртуальной машины происходит применение настроек SSH, включая открытие порта 2022, корректную настройку SELinux и перезапуск службы sshd. Это позволяет быстро развернуть виртуальную машину с заранее подготовленной конфигурацией.

# Вывод

В ходе работы была выполнена настройка удалённого доступа по SSH: запрещён вход под пользователем root, ограничен доступ списком разрешённых пользователей, добавлен дополнительный порт для подключения и настроены правила SELinux и межсетевого экрана. Реализована аутентификация по ключу и создан SSH-туннель с локальным перенаправлением порта. Развернут автоматизационный скрипт, позволяющий повторно применять конфигурацию.

# Контрольные вопросы

1. **Вы хотите запретить удалённый доступ по SSH на сервер пользователю root и разрешить доступ пользователю alice. Как это сделать?**  
   В файле `/etc/ssh/sshd_config` установить:
   - `PermitRootLogin no` — запрет входа root по SSH,
   - `AllowUsers alice` — разрешение доступа только пользователю alice,
   затем перезапустить sshd.

2. **Как настроить удалённый доступ по SSH через несколько портов? Для чего это может потребоваться?**  
   В файле `sshd_config` указать несколько строк `Port`, например:
   - `Port 22`
   - `Port 2022`  
   Это позволяет подключаться по альтернативному порту при ошибках настройки или для повышения безопасности.

3. **Какие параметры используются для создания туннеля SSH, когда команда ssh устанавливает фоновое соединение и не ожидает конкретной команды?**  
   Используются параметры:
   - `-f` — перевод ssh в фоновый режим,
   - `-N` — не запускать удалённую команду,
   - `-L` — локальное перенаправление порта.

4. **Как настроить локальную переадресацию с локального порта 5555 на порт 80 сервера server2.example.com?**  
   Использовать команду: `ssh -fNL 5555:localhost:80 user@server2.example.com`
   
Теперь обращение к `localhost:5555` перенаправляется на порт 80 сервера.

5. **Как настроить SELinux, чтобы позволить SSH связываться с портом 2022?**  
Добавить порт в список разрешённых для ssh: `semanage port -a -t ssh_port_t -p tcp 2022`


6. **Как настроить межсетевой экран на сервере, чтобы разрешить входящие подключения по SSH через порт 2022?**  
Внести порт в правила firewalld:

`firewall-cmd --add-port=2022/tcp`
`firewall-cmd --add-port=2022/tcp --permanent`

Затем перезапустить правила либо службу firewalld.
