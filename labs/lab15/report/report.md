---
## Front matter
title: "Отчёт по лабораторной работе 15"
subtitle: "Настройка сетевого журналирования"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получение навыков по работе с журналами системных событий.

# Выполнение работы

## Настройка сервера сетевого журнала

1. На виртуальной машине **server** был создан файл конфигурации сетевого хранения журналов. Для этого выполнен переход в каталог `/etc/rsyslog.d`, после чего создан файл `netlog-server.conf`.

2. В файле `/etc/rsyslog.d/netlog-server.conf` включён приём сообщений журнала по протоколу TCP на порту **514**. Для этого были добавлены директивы загрузки модуля TCP и запуска TCP-сервера rsyslog.

   ![Конфигурация netlog-server.conf](01.png){ #fig:001 width=80% }

3. После внесения изменений служба **rsyslog** была перезапущена. С помощью утилиты **lsof** проверено, что служба прослушивает TCP-порт 514 и готова принимать входящие соединения.

   ![Проверка прослушиваемых портов rsyslog](02.png){ #fig:002 width=80% }

4. Для обеспечения сетевого доступа к серверу журналов были добавлены правила межсетевого экрана, разрешающие входящие подключения к TCP-порту 514. Изменения применены как временно, так и на постоянной основе.

   ![Настройка firewall для порта 514](03.png){ #fig:003 width=80% }

## Настройка клиента сетевого журнала

1. На виртуальной машине **client** в каталоге `/etc/rsyslog.d` создан файл конфигурации `netlog-client.conf`, предназначенный для настройки пересылки журналов на удалённый сервер.

2. В файле `/etc/rsyslog.d/netlog-client.conf` включено перенаправление всех сообщений журнала на сервер по TCP-протоколу на порт 514 с использованием синтаксиса `@@`, что указывает на надёжную TCP-передачу.

   ![Конфигурация netlog-client.conf](04.png){ #fig:004 width=80% }

3. После изменения конфигурации служба **rsyslog** на клиенте была перезапущена для применения новых настроек.

## Проверка приёма и просмотра журналов

1. На сервере выполнен просмотр системного журнала `/var/log/messages` в режиме реального времени с помощью команды `tail -f`. Установлено, что в журнале отображаются сообщения как от локальной системы, так и от удалённого клиента.

   ![Просмотр сообщений журнала на сервере](05.png){ #fig:005 width=80% }

2. Под пользовательской сессией на сервере была запущена графическая утилита **gnome-system-monitor**, с помощью которой выполнен анализ нагрузки на ресурсы системы и сетевой активности.

   ![Мониторинг ресурсов системы](06.png){ #fig:006 width=80% }

3. Выполнена попытка установки консольного просмотрщика журналов **lnav**. В процессе установки получено сообщение об отсутствии пакета в доступных репозиториях, что свидетельствует о необходимости дополнительной настройки источников пакетов либо использования альтернативных средств.

   ![Попытка установки lnav](07.png){ #fig:007 width=80% }

## Автоматизация настройки с помощью provisioning-скриптов

1. На виртуальной машине **server** в каталоге `/vagrant/provision/server` создана структура каталогов для хранения конфигурационных файлов сетевого журнала. В неё был скопирован файл `netlog-server.conf` с сохранением структуры каталогов.

2. В каталоге `/vagrant/provision/server` создан исполняемый скрипт `netlog.sh`, предназначенный для автоматической настройки сервера сетевого журнала. Скрипт выполняет копирование конфигурационных файлов, настройку межсетевого экрана и перезапуск службы rsyslog.

   ![Provisioning-скрипт сервера](08.png){ #fig:008 width=80% }

3. Аналогичный provisioning-скрипт был подготовлен для клиентской виртуальной машины и включает установку необходимых пакетов, копирование конфигурации и перезапуск службы rsyslog, что обеспечивает автоматическую настройку клиента сетевого журнала.

# Вывод

В ходе работы был настроен сервер сетевого журнала на основе rsyslog. Реализован приём журналов по TCP-протоколу на порту 514, а также настроена пересылка сообщений с клиентской виртуальной машины на сервер. Проверена корректность приёма и отображения журналов, выполнена настройка межсетевого экрана и подготовлены provisioning-скрипты для автоматизации развёртывания, что упрощает повторную настройку среды и снижает вероятность ошибок.

# Контрольные вопросы

1. **Какой модуль rsyslog вы должны использовать для приёма сообщений от journald?**  
   Для приёма сообщений от journald используется модуль `imjournal`.

2. **Как называется устаревший модуль, который можно использовать для включения приёма сообщений журнала в rsyslog?**  
   Устаревшим модулем является `imuxsock`, который получает сообщения через сокет `/dev/log`.

3. **Чтобы убедиться, что устаревший метод приёма сообщений из journald в rsyslog не используется, какой дополнительный параметр следует использовать?**  
   Необходимо использовать параметр `UseJournal="on"` в настройках модуля `imjournal`, чтобы rsyslog работал напрямую с journald.

4. **В каком конфигурационном файле содержатся настройки, которые позволяют вам настраивать работу журнала?**  
   Основные настройки журнала systemd находятся в файле `/etc/systemd/journald.conf`.

5. **Каким параметром управляется пересылка сообщений из journald в rsyslog?**  
   Пересылка сообщений управляется параметром `ForwardToSyslog` в файле `journald.conf`.

6. **Какой модуль rsyslog вы можете использовать для включения сообщений из файла журнала, не созданного rsyslog?**  
   Для чтения сообщений из произвольных файлов используется модуль `imfile`.

7. **Какой модуль rsyslog вам нужно использовать для пересылки сообщений в базу данных MariaDB?**  
   Для пересылки сообщений в MariaDB используется модуль `ommysql`.

8. **Какие две строки вам нужно включить в rsyslog.conf, чтобы позволить текущему журнальному серверу получать сообщения через TCP?**  
   Необходимо добавить следующие строки:

```
$ModLoad imtcp
$InputTCPServerRun 514
```

9. **Как настроить локальный брандмауэр, чтобы разрешить приём сообщений журнала через порт TCP 514?**  
Для этого используются команды:

```
firewall-cmd --add-port=514/tcp
firewall-cmd --add-port=514/tcp --permanent
```