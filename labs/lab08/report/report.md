---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Заур Мустафаев"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTPсервера.

# Выполнение работы

## Установка и первичная настройка Postfix на сервере

1. На виртуальной машине **server** выполнен вход под учётной записью администратора и произведена установка почтового сервера **Postfix** и почтового клиента **s-nail**.

2. Настроен межсетевой экран: добавлено правило, разрешающее работу службы **SMTP**, а также проверен список активных сервисов файрвола.

3. Выполнено восстановление контекста безопасности **SELinux** для каталога `/etc`, что необходимо для корректной работы сервисов после изменения конфигурационных файлов.

4. Служба **Postfix** добавлена в автозагрузку и успешно запущена.

   ![Запуск и включение Postfix](01.png){ #fig:001 width=80% }

## Изменение параметров Postfix с помощью postconf

1. Просмотрен полный список текущих параметров конфигурации Postfix с помощью утилиты **postconf**.

   ![Просмотр параметров Postfix](02.png){ #fig:002 width=80% }

2. Проверены значения параметров **myorigin** и **mydomain**. Установлено, что домен задан как `zmustafaev.net`.

3. Значение параметра **myorigin** изменено на значение параметра **mydomain**, после чего повторно выполнена проверка.

   ![Изменение параметра myorigin](03.png){ #fig:003 width=80% }

4. Выполнена проверка конфигурации Postfix и перечитаны конфигурационные файлы без возникновения ошибок.

5. Просмотрены параметры, отличающиеся от значений по умолчанию, с помощью команды `postconf -n`.

   ![Параметры Postfix, отличные от стандартных](04.png){ #fig:004 width=80% }

6. Жёстко задано значение параметра **mydomain**, после чего отключена поддержка IPv6 — в работе Postfix оставлен только протокол IPv4.

   ![Отключение IPv6 в Postfix](05.png){ #fig:005 width=80% }

7. Конфигурация повторно проверена и успешно перечитана службой.

## Проверка работы Postfix на сервере

1. Под учётной записью пользователя выполнена отправка тестового письма самому себе с использованием утилиты **mail**.

   ![Отправка тестового письма с сервера](06.png){ #fig:006 width=80% }

2. Проверено содержимое каталога `/var/spool/mail`. Установлено, что почтовый ящик пользователя создан, а сообщение успешно доставлено.

3. Проанализирован журнал `/var/log/maillog`. По записям `status=sent (delivered to mailbox)` сделан вывод об успешной доставке сообщения.

   ![Журнал доставки письма на сервере](07.png){ #fig:007 width=80% }

## Настройка Postfix на клиенте и проверка взаимодействия

1. На виртуальной машине **client** установлены пакеты **postfix** и **s-nail**, после чего отключена поддержка IPv6.

   ![Установка и настройка Postfix на клиенте](08.png){ #fig:008 width=80% }

2. Служба **Postfix** на клиенте добавлена в автозагрузку и запущена.

3. С клиента выполнена отправка почтового сообщения на сервер. В журнале сервера зафиксировано подключение клиента, однако сообщение не было доставлено из-за ограничений параметров сетевого доступа.

## Настройка сетевых параметров Postfix на сервере

1. Проверены текущие значения параметров **inet_interfaces** и **mynetworks**. Установлено, что Postfix принимал соединения только с локального узла.

   ![Проверка параметров inet_interfaces и mynetworks](09.png){ #fig:009 width=80% }

2. Разрешено прослушивание всех сетевых интерфейсов путём установки значения `inet_interfaces = all`.

3. В параметр **mynetworks** добавлена внутренняя сеть `192.168.0.0/16`, что разрешило пересылку сообщений между узлами локальной сети.

4. Выполнена проверка конфигурации и перезапуск службы Postfix.

## Повторная проверка доставки почты с клиента

1. Повторно отправлено сообщение с клиента на сервер.

2. В журнале сервера зафиксирована успешная обработка SMTP-сеанса и доставка сообщения в почтовый ящик пользователя, что подтверждается строками `status=sent (delivered to mailbox)`.

   ![Успешная доставка письма с клиента](10.png){ #fig:010 width=80% }

## Конфигурация Postfix для домена и анализ доставки почты

1. С виртуальной машины **client** выполнена отправка почтового сообщения на доменный адрес вида `user@user.net`.  
   В результате сообщение не было доставлено и помещено в очередь почтового сервера.

   ![Отправка письма на доменный адрес и состояние очереди](11.png){ #fig:011 width=80% }

2. Проанализировано содержимое очереди Postfix. Установлено, что сервер не смог установить соединение с почтовым сервером домена, что указывает на отсутствие корректной маршрутизации доменной почты.

3. Выполнен анализ журнала `/var/log/maillog` на сервере. В логах зафиксированы ошибки:
   - невозможность доставки почты на самого себя,
   - отсутствие маршрута до узла клиента,
   - перевод сообщения в состояние `bounced` и `deferred`.

   ![Ошибки доставки почты в журнале maillog](12.png){ #fig:012 width=80% }

4. Для обеспечения корректной доставки почты по доменному имени изучены файлы прямой и обратной DNS-зон. Установлено, что в прямой зоне домена добавлена MX-запись, указывающая на почтовый сервер `mail.zmustafaev.net`, а также соответствующие A-записи.

   ![Файл прямой DNS-зоны с MX-записью](13.png){ #fig:013 width=80% }

5. Проверен файл обратной DNS-зоны. Убедились в наличии PTR-записей для сервера, клиента и почтового узла, что необходимо для корректной работы почтового сервера и обратного разрешения имён.

   ![Файл обратной DNS-зоны](14.png){ #fig:014 width=80% }

6. В конфигурацию Postfix добавлен домен в список конечных точек доставки почты путём изменения параметра **mydestination**. После внесения изменений выполнена проверка конфигурации и перечитаны конфигурационные файлы Postfix.

   ![Изменение параметра mydestination](15.png){ #fig:015 width=80% }

7. Восстановлены контексты безопасности **SELinux** для каталогов `/etc` и `/var/named`, после чего служба DNS была перезапущена для применения изменений.

8. После корректировки DNS-записей и параметров Postfix выполнена повторная попытка отправки сообщений из очереди. Сообщения были успешно переданы почтовым сервером.

9. В журнале `/var/log/maillog` зафиксирована успешная доставка письма, что подтверждается строками со статусом `status=sent (delivered to mailbox)`.

   ![Успешная доставка доменной почты](16.png){ #fig:016 width=80% }

10. Проверено содержимое почтового ящика пользователя на сервере. Установлено, что сообщение, отправленное с клиента на доменный адрес, успешно доставлено и сохранено в локальном mailbox.

   ![Содержимое почтового ящика с доставленным письмом](17.png){ #fig:017 width=80% }

## 8.4.5. Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На виртуальной машине **server** выполнен переход в каталог `/vagrant/provision/server/`, предназначенный для хранения файлов настройки внутреннего окружения виртуальной машины и сценариев автоматической конфигурации.

2. Произведена замена конфигурационных файлов DNS-сервера. Для этого актуальные файлы зон из рабочего каталога `/var/named` были скопированы в каталог provisioning `/vagrant/provision/server/dns/var/named`.  
   Данное действие позволяет сохранить текущую конфигурацию DNS и применять её автоматически при повторном развёртывании виртуальной машины.

3. В каталоге `/vagrant/provision/server` создан исполняемый файл **mail.sh**, предназначенный для автоматизации установки и настройки почтового сервера Postfix на серверной виртуальной машине. Файлу были назначены права на выполнение.

   ![Скрипт автоматической настройки Postfix на сервере](18.png){ #fig:018 width=80% }

5. На виртуальной машине **client** выполнен переход в каталог `/vagrant/provision/client/`, предназначенный для хранения файлов настройки клиентского окружения.

6. В указанном каталоге создан исполняемый файл **mail.sh**, который используется для автоматизированной установки и базовой настройки почтового клиента Postfix на клиентской виртуальной машине.

   ![Скрипт автоматической настройки Postfix на клиенте](19.png){ #fig:019 width=80% }

# Вывод

В ходе выполнения лабораторной работы был установлен и настроен почтовый сервер **Postfix**. Произведена базовая конфигурация параметров сервера, обеспечивающая отправку и приём почты как с локального узла, так и с других машин внутренней сети. Настроена доставка сообщений по доменному имени с использованием DNS-записей, выполнена проверка работы почтовой службы и анализ журналов. Дополнительно подготовлены сценарии автоматической настройки окружения для Vagrant, что позволяет упростить повторное развёртывание и обеспечить воспроизводимость конфигурации.

# Контрольные вопросы

1. **В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?**  
   Основная конфигурация Postfix располагается в каталоге `/etc/postfix/`. Главный файл настроек — `main.cf`, дополнительные параметры служб описываются в файле `master.cf`.

2. **Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?**  
   Для проверки корректности конфигурации используется команда `postfix check`, которая анализирует синтаксис и сообщает об ошибках в настройках.

3. **В каких параметрах конфигурации Postfix требуется внести изменения для отправки писем не только на локальный хост, но и на доменные адреса?**  
   Для этого настраиваются параметры:
   - `mydestination` — список доменов, для которых сервер является конечной точкой доставки;
   - `inet_interfaces` — сетевые интерфейсы, на которых Postfix принимает соединения;
   - `mynetworks` — список доверенных сетей, с которых разрешена пересылка почты;
   - `mydomain` и `myorigin` — параметры доменной принадлежности отправляемых сообщений.

4. **Приведите примеры работы с утилитой mail.**  
   Утилита `mail` позволяет:
   - отправить письмо пользователю;
   - просмотреть список полученных писем;
   - удалить выбранное письмо из почтового ящика.

5. **Приведите примеры работы с утилитой postqueue.**  
   Утилита `postqueue` используется для управления очередью сообщений Postfix и позволяет:
   - просмотреть содержимое очереди сообщений;
   - определить количество писем, находящихся в очереди;
   - инициировать повторную отправку всех сообщений из очереди;
   - удалить отдельные сообщения из очереди по их идентификатору.


# Список литературы

1. Postfix Documentation. — URL: http://www.postfix.org/documentation.html (visited on 09/13/2021).
